<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kbstar.mbc.dc.accountdc.mapper.AccountMapper">

    <!-- 결과 맵 정의 -->
    <resultMap id="AccountResultMap" type="com.kbstar.mbc.dc.accountdc.Account">
        <id column="ACCOUNT_NUMBER" property="accountNumber" jdbcType="VARCHAR"/>
        <result column="NAME" property="name" jdbcType="VARCHAR"/>
        <result column="IDENTIFICATION_NUMBER" property="identificationNumber" jdbcType="VARCHAR"/>
        <result column="INTEREST_RATE" property="interestRate" jdbcType="DECIMAL"/>
        <result column="LAST_TRANSACTION" property="lastTransaction" jdbcType="VARCHAR"/>
        <result column="PASSWORD" property="password" jdbcType="VARCHAR"/>
        <result column="NET_AMOUNT" property="netAmount" jdbcType="DECIMAL"/>
        <result column="USE_YN" property="useYn" jdbcType="VARCHAR"/>
        <result column="DEL_YN" property="delYn" jdbcType="VARCHAR"/>
        <result column="REG_DT" property="regDt" jdbcType="VARCHAR"/>
        <result column="UPD_DT" property="updDt" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 공통 WHERE 조건 -->
    <sql id="commonWhere">
        <where>
            <if test="useYn != null and useYn != ''">
                AND USE_YN = #{useYn}
            </if>
            <if test="delYn != null and delYn != ''">
                AND DEL_YN = #{delYn}
            </if>
        </where>
    </sql>

    <!-- 계정 조회 -->
    <select id="getAccount" parameterType="com.kbstar.mbc.dc.accountdc.dto.AccountDDTO" resultMap="AccountResultMap">
        SELECT 
            ACCOUNT_NUMBER,
            NAME,
            IDENTIFICATION_NUMBER,
            INTEREST_RATE,
            LAST_TRANSACTION,
            PASSWORD,
            NET_AMOUNT,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        FROM TB_ACCOUNT
        WHERE ACCOUNT_NUMBER = #{accountNumber}
        AND DEL_YN = 'N'
    </select>

    <!-- 계정 목록 조회 -->
    <select id="getListAccount" parameterType="com.kbstar.mbc.dc.accountdc.dto.AccountDDTO" resultMap="AccountResultMap">
        SELECT 
            ACCOUNT_NUMBER,
            NAME,
            IDENTIFICATION_NUMBER,
            INTEREST_RATE,
            LAST_TRANSACTION,
            PASSWORD,
            NET_AMOUNT,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        FROM TB_ACCOUNT
        <include refid="commonWhere"/>
        <if test="accountNumber != null and accountNumber != ''">
            AND ACCOUNT_NUMBER LIKE '%' || #{accountNumber} || '%'
        </if>
        <if test="name != null and name != ''">
            AND NAME LIKE '%' || #{name} || '%'
        </if>
        <if test="identificationNumber != null and identificationNumber != ''">
            AND IDENTIFICATION_NUMBER LIKE '%' || #{identificationNumber} || '%'
        </if>
        ORDER BY REG_DT DESC
    </select>

    <!-- 계정 생성 -->
    <insert id="createAccount" parameterType="com.kbstar.mbc.dc.accountdc.dto.AccountDDTO">
        INSERT INTO TB_ACCOUNT (
            ACCOUNT_NUMBER,
            NAME,
            IDENTIFICATION_NUMBER,
            INTEREST_RATE,
            LAST_TRANSACTION,
            PASSWORD,
            NET_AMOUNT,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        ) VALUES (
            #{accountNumber},
            #{name},
            #{identificationNumber},
            #{interestRate},
            #{lastTransaction},
            #{password},
            #{netAmount},
            'Y',
            'N',
            TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'),
            TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        )
    </insert>

    <!-- 계정 수정 -->
    <update id="updateAccount" parameterType="com.kbstar.mbc.dc.accountdc.dto.AccountDDTO">
        UPDATE TB_ACCOUNT
        SET 
            NAME = #{name},
            IDENTIFICATION_NUMBER = #{identificationNumber},
            INTEREST_RATE = #{interestRate},
            LAST_TRANSACTION = #{lastTransaction},
            PASSWORD = #{password},
            NET_AMOUNT = #{netAmount},
            UPD_DT = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE ACCOUNT_NUMBER = #{accountNumber}
    </update>

    <!-- 계정 삭제 -->
    <delete id="deleteAccount" parameterType="com.kbstar.mbc.dc.accountdc.dto.AccountDDTO">
        DELETE FROM TB_ACCOUNT
        WHERE ACCOUNT_NUMBER = #{accountNumber}
    </delete>

    <!-- 계좌번호로 계정 조회 -->
    <select id="getAccountByNumber" parameterType="string" resultMap="AccountResultMap">
        SELECT 
            ACCOUNT_NUMBER,
            NAME,
            IDENTIFICATION_NUMBER,
            INTEREST_RATE,
            LAST_TRANSACTION,
            PASSWORD,
            NET_AMOUNT,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        FROM TB_ACCOUNT
        WHERE ACCOUNT_NUMBER = #{accountNumber}
        AND DEL_YN = 'N'
    </select>

    <!-- 계정 존재 여부 확인 -->
    <select id="existsAccount" parameterType="string" resultType="int">
        SELECT COUNT(1)
        FROM TB_ACCOUNT
        WHERE ACCOUNT_NUMBER = #{accountNumber}
        AND DEL_YN = 'N'
    </select>

    <!-- 잔액 업데이트 -->
    <update id="updateBalance">
        UPDATE TB_ACCOUNT
        SET 
            NET_AMOUNT = #{netAmount},
            UPD_DT = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE ACCOUNT_NUMBER = #{accountNumber}
    </update>

    <!-- 마지막 거래일 업데이트 -->
    <update id="updateLastTransaction">
        UPDATE TB_ACCOUNT
        SET 
            LAST_TRANSACTION = #{lastTransaction},
            UPD_DT = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE ACCOUNT_NUMBER = #{accountNumber}
    </update>

</mapper> 