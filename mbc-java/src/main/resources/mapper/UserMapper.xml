<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kbstar.mbc.dc.usermgtdc.mapper.UserMapper">

    <!-- 결과 맵 정의 -->
    <resultMap id="UserResultMap" type="com.kbstar.mbc.dc.usermgtdc.User">
        <id column="USER_ID" property="userId" jdbcType="VARCHAR"/>
        <result column="USER_NAME" property="userName" jdbcType="VARCHAR"/>
        <result column="USER_EMAIL" property="userEmail" jdbcType="VARCHAR"/>
        <result column="USER_PASSWORD" property="userPassword" jdbcType="VARCHAR"/>
        <result column="USER_ROLE" property="userRole" jdbcType="VARCHAR"/>
        <result column="USE_YN" property="useYn" jdbcType="VARCHAR"/>
        <result column="DEL_YN" property="delYn" jdbcType="VARCHAR"/>
        <result column="REG_DT" property="regDt" jdbcType="VARCHAR"/>
        <result column="UPD_DT" property="updDt" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="PageResultMap" type="com.kbstar.mbc.dc.usermgtdc.Page">
        <id column="PAGE_ID" property="pageId" jdbcType="VARCHAR"/>
        <result column="PAGE_NAME" property="pageName" jdbcType="VARCHAR"/>
        <result column="PAGE_URL" property="pageUrl" jdbcType="VARCHAR"/>
        <result column="PARENT_PAGE_ID" property="parentPageId" jdbcType="VARCHAR"/>
        <result column="SORT_ORDER" property="sortOrder" jdbcType="INTEGER"/>
        <result column="USE_YN" property="useYn" jdbcType="VARCHAR"/>
        <result column="TOTAL_LINE_CNT" property="totalLineCnt" jdbcType="INTEGER"/>
        <result column="OUTPT_LINE_CNT" property="outptLineCnt" jdbcType="INTEGER"/>
    </resultMap>

    <resultMap id="TreeResultMap" type="com.kbstar.mbc.dc.usermgtdc.Tree">
        <id column="TREE_ID" property="treeId" jdbcType="VARCHAR"/>
        <result column="TREE_NAME" property="treeName" jdbcType="VARCHAR"/>
        <result column="PARENT_TREE_ID" property="parentTreeId" jdbcType="VARCHAR"/>
        <result column="TREE_LEVEL" property="treeLevel" jdbcType="INTEGER"/>
        <result column="SORT_ORDER" property="sortOrder" jdbcType="INTEGER"/>
        <result column="USE_YN" property="useYn" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 공통 WHERE 조건 -->
    <sql id="commonWhere">
        <where>
            <if test="useYn != null and useYn != ''">
                AND USE_YN = #{useYn}
            </if>
            <if test="delYn != null and delYn != ''">
                AND DEL_YN = #{delYn}
            </if>
        </where>
    </sql>

    <!-- 사용자 목록 조회 -->
    <select id="getListUser" parameterType="com.kbstar.mbc.dc.usermgtdc.dto.UserDDTO" resultMap="UserResultMap">
        SELECT 
            USER_ID,
            USER_NAME,
            USER_EMAIL,
            USER_PASSWORD,
            USER_ROLE,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        FROM TB_USER
        <include refid="commonWhere"/>
        <if test="userId != null and userId != ''">
            AND USER_ID LIKE '%' || #{userId} || '%'
        </if>
        <if test="userName != null and userName != ''">
            AND USER_NAME LIKE '%' || #{userName} || '%'
        </if>
        <if test="userEmail != null and userEmail != ''">
            AND USER_EMAIL LIKE '%' || #{userEmail} || '%'
        </if>
        ORDER BY REG_DT DESC
    </select>

    <!-- 사용자 등록 -->
    <insert id="insertUser" parameterType="com.kbstar.mbc.dc.usermgtdc.dto.UserDDTO">
        INSERT INTO TB_USER (
            USER_ID,
            USER_NAME,
            USER_EMAIL,
            USER_PASSWORD,
            USER_ROLE,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        ) VALUES (
            #{userId},
            #{userName},
            #{userEmail},
            #{userPassword},
            #{userRole},
            'Y',
            'N',
            TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'),
            TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        )
    </insert>

    <!-- 사용자 수정 -->
    <update id="updateUser" parameterType="com.kbstar.mbc.dc.usermgtdc.dto.UserDDTO">
        UPDATE TB_USER
        SET 
            USER_NAME = #{userName},
            USER_EMAIL = #{userEmail},
            USER_PASSWORD = #{userPassword},
            USER_ROLE = #{userRole},
            UPD_DT = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE USER_ID = #{userId}
    </update>

    <!-- 사용자 삭제 (논리 삭제) -->
    <update id="deleteUser" parameterType="com.kbstar.mbc.dc.usermgtdc.dto.UserDDTO">
        UPDATE TB_USER
        SET 
            DEL_YN = 'Y',
            UPD_DT = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE USER_ID = #{userId}
    </update>

    <!-- 페이징 데이터 조회 -->
    <select id="getListPage" parameterType="com.kbstar.mbc.dc.usermgtdc.dto.PageDDTO" resultMap="PageResultMap">
        SELECT 
            PAGE_ID,
            PAGE_NAME,
            PAGE_URL,
            PARENT_PAGE_ID,
            SORT_ORDER,
            USE_YN
        FROM TB_PAGE
        <include refid="commonWhere"/>
        <if test="pageName != null and pageName != ''">
            AND PAGE_NAME LIKE '%' || #{pageName} || '%'
        </if>
        ORDER BY SORT_ORDER
    </select>

    <!-- 전체 데이터 개수 조회 -->
    <select id="getPageCount" parameterType="com.kbstar.mbc.dc.usermgtdc.dto.PageDDTO" resultType="string">
        SELECT COUNT(1)
        FROM TB_PAGE
        <include refid="commonWhere"/>
        <if test="pageName != null and pageName != ''">
            AND PAGE_NAME LIKE '%' || #{pageName} || '%'
        </if>
    </select>

    <!-- 트리 구조 데이터 조회 -->
    <select id="getListTree" parameterType="com.kbstar.mbc.dc.usermgtdc.dto.TreeDDTO" resultMap="TreeResultMap">
        SELECT 
            TREE_ID,
            TREE_NAME,
            PARENT_TREE_ID,
            TREE_LEVEL,
            SORT_ORDER,
            USE_YN
        FROM TB_TREE
        <include refid="commonWhere"/>
        <if test="nodeid != null and nodeid != ''">
            AND PARENT_TREE_ID = #{nodeid}
        </if>
        ORDER BY SORT_ORDER
    </select>

    <!-- 사용자 ID로 사용자 조회 -->
    <select id="getUserById" parameterType="string" resultMap="UserResultMap">
        SELECT 
            USER_ID,
            USER_NAME,
            USER_EMAIL,
            USER_PASSWORD,
            USER_ROLE,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        FROM TB_USER
        WHERE USER_ID = #{userId}
        AND DEL_YN = 'N'
    </select>

    <!-- 사용자 이메일로 사용자 조회 -->
    <select id="getUserByEmail" parameterType="string" resultMap="UserResultMap">
        SELECT 
            USER_ID,
            USER_NAME,
            USER_EMAIL,
            USER_PASSWORD,
            USER_ROLE,
            USE_YN,
            DEL_YN,
            REG_DT,
            UPD_DT
        FROM TB_USER
        WHERE USER_EMAIL = #{userEmail}
        AND DEL_YN = 'N'
    </select>

    <!-- 사용자 존재 여부 확인 -->
    <select id="existsUser" parameterType="string" resultType="int">
        SELECT COUNT(1)
        FROM TB_USER
        WHERE USER_ID = #{userId}
        AND DEL_YN = 'N'
    </select>

</mapper> 