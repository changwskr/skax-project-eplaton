package com.kbstar.mbc.fc.foundation.bzcrudbus.business.as;

import com.kbstar.ksa.exception.BusinessException;
import com.kbstar.ksa.infra.po.KBData;
import com.kbstar.ksa.oltp.biz.IApplicationService;
import com.kbstar.mbc.fc.foundation.bzcrudbus.constant.Constants;
import com.kbstar.mbc.fc.foundation.bzcrudbus.exception.BTFSPException;
import com.kbstar.mbc.fc.foundation.bzcrudbus.exception.TPMRecvException;
import com.kbstar.mbc.fc.foundation.bzcrudbus.exception.TPMSendException;
import com.kbstar.mbc.fc.foundation.bzcrudbus.foundation.utility.ErrorCheckUtil;
import com.kbstar.mbc.fc.foundation.bzcrudbus.log.IIfrsLogger;
import com.kbstar.mbc.fc.foundation.bzcrudbus.log.IfrsLogHelper;
import com.kbstar.mbc.fc.foundation.bzcrudbus.tcf.TCF;
import com.kbstar.mbc.fc.foundation.bzcrudbus.tpm.TPMUtil;
import com.kbstar.mbc.fc.foundation.bzcrudbus.transfer.IFRSEvent;

public class ASComExec implements IApplicationService {

	protected IIfrsLogger logger = IfrsLogHelper.getServer();
	public static String transactionMode = Constants.TRANSACTION_MODE_SERVER;

	public KBData execute(KBData reqData) throws BusinessException {
	/*			
		if (logger.isDebugEnabled()) {
			logger.debug(this.getClass().getName() + ", log test입니다.");
		}
	*/
		try{
			
			IFRSEvent ifrsEvent = TPMUtil.TPSRecv(reqData);
				
			TCF tcf = new TCF(transactionMode);
			
			ifrsEvent = tcf.execute(ifrsEvent);
			
			//TCF 모듈에서 난 에러 체크
			String errorCode = ifrsEvent.getCommonDto().getErrorCode();			
			if(ErrorCheckUtil.getInstance().isError(ifrsEvent.getCommonDto().getErrorCode().charAt(0))) {
				
				logger.info(ifrsEvent.getCommonDto().getSeqNo(), "[CommExecAS] Exception Catched And Throw BusinessException (ErrorCode : "+errorCode+")");
				
				throw ifrsEvent.getException();
			}
			
			return TPMUtil.TPSSend(ifrsEvent);
		}
		catch(TPMRecvException re){
			re.printStackTrace();
			throw new BusinessException("S9001001", "TPMRECV", re.toString());
		}
		catch(BTFSPException spe){
			spe.printStackTrace();
			throw new BusinessException(spe.getErrorCode(), "TCFEXEC", spe.toString());
		}
		catch(TPMSendException se){
			se.printStackTrace();
			throw new BusinessException("S9001002", "TPMSEND", se.toString());
		}
		catch(Exception e){
			e.printStackTrace();
			throw new BusinessException("S9001003", "COMMEXECAS", e.toString());
		}
		
	}
}
