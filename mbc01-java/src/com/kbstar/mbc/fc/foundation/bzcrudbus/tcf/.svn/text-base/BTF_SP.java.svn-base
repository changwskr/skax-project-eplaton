package com.kbstar.mbc.fc.foundation.bzcrudbus.tcf;

import java.util.ArrayList;
import java.util.HashMap;

import com.kbstar.mbc.fc.foundation.bzcrudbus.config.ActionConfig;
import com.kbstar.mbc.fc.foundation.bzcrudbus.config.CommandObj;
import com.kbstar.mbc.fc.foundation.bzcrudbus.exception.BTFSPException;
import com.kbstar.mbc.fc.foundation.bzcrudbus.exception.TPMSendException;
import com.kbstar.mbc.fc.foundation.bzcrudbus.log.IIfrsLogger;
import com.kbstar.mbc.fc.foundation.bzcrudbus.log.IfrsLogHelper;
import com.kbstar.mbc.fc.foundation.bzcrudbus.tpm.TPMUtil;
import com.kbstar.mbc.fc.foundation.bzcrudbus.transfer.IFRSCommonDTO;
import com.kbstar.mbc.fc.foundation.bzcrudbus.transfer.IFRSEvent;

/**
 * <p>
 * Title:
 * </p>
 * 
 * <p>
 * Description: This is oversea banking package.
 * </p>
 * 
 * 
 * @version 1.0
 * 
 */

public class BTF_SP {

	private static BTF_SP instance;


	private IIfrsLogger logger = IfrsLogHelper.getServer();
	
	/**
	 * 
	 * BTF에 대한 인스턴스를 생성한다.
	 * 
	 * @return BTF
	 * 
	 */

	public static synchronized BTF_SP getInstance() {

		if (instance == null) {
			try {
				instance = new BTF_SP();
			} catch (Exception igex) {
			}
		}
		return instance;

	}

	public BTF_SP() {
	}


	/**
	 * 실행함수.
	 * 
	 * @param ppifrsevent
	 *            IFRSEvent
	 * @return IFRSEvent
	 */

	public IFRSEvent execute(IFRSEvent ifrsEvent) throws BTFSPException {

		try {
			logger.info(ifrsEvent.getCommonDto().getTransactionNo(), "[BTF_SP] begin");

			IFRSCommonDTO commonDTO = ifrsEvent.getCommonDto();
			commonDTO.setToMap(new HashMap());
			String cmdId = ifrsEvent.getCommonDto().getCommandId();
			ArrayList callInfoList = ActionConfig.getInstance(cmdId.substring(0, 3).toUpperCase()).getCmdList(cmdId);
			
			/*
			 * PC 단으로의 메소드 인보크를 실시한다.
			 */

			CommandObj cmdObj = null;

			for (int i = 0; i < callInfoList.size(); i++) {
				
				cmdObj = (CommandObj) callInfoList.get(i);
				
				TPMUtil.TPSSendRecv(commonDTO, cmdObj);
				
			}
		
			/*
			 * DC/PC단에서 처리한 내용을 가진 CommonDTO을 IFRSEvent에 셋팅한다.
			 */
						
			logger.info(ifrsEvent.getCommonDto().getTransactionNo(), "[BTF_SP] end]");
		
			return ifrsEvent;

		} catch (TPMSendException tse) {
			ifrsEvent.getCommonDto().setErrorCode(tse.getErrorCode());
			ifrsEvent.getCommonDto().setErrorMsg(tse.getMessage());
			throw new BTFSPException(tse.getErrorCode(), tse.toString());	
		} catch (Exception ex) {
			ifrsEvent.getCommonDto().setErrorCode("ESBTF01001");
			ifrsEvent.getCommonDto().setErrorMsg(ex.getMessage());
			throw new BTFSPException("ESBTF01001", ex.toString());
		}

	}

}
